@page "/logmessages"
@using Cosei.Client.Base;
@using Cosei.Client.Http;
@using Microsoft.Extensions.Localization;
@using LogService.Blazor.Identity;
@using LogService.Blazor.Services;
@using LogService.Client.Data.Models;
@using LogService.Client.Data.Services;
@using LogService.Client.Data;
@using LogService.Client.Localisation;
@using LogService.Contracts.Events;
@inject ILogger<LogMessages> Log
@inject ILogMessageService LogMessageService
@inject ISubscriberProvider SubscriberProvider
@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>@LogMessageLoc.LogMessages</PageTitle>

@if (logMessages == null)
{
	<p><em>@CommonLoc.Loading...</em></p>
}
else
{
	<div class="row border-bottom">
		<div class="col-6 col-xl-2 fw-bold">
			@LogMessageLoc.DateTime
		</div>
		<div class="col-6 col-xl-1 fw-bold">
			@LogMessageLoc.LogLevel
		</div>
		<div class="col-xl-9 fw-bold">
			@LogMessageLoc.Message
		</div>
	</div>

	@foreach (var logMessage in logMessages)
	{
		<div class="row border-bottom">
			<div class="col-6 col-xl-2">
				@logMessage.DateTime
			</div>
			<div class="col-6 col-xl-1">
				@logMessage.LogLevel
			</div>
			<div class="col-xl-9">
				<a href="/LogMessage/@logMessage.Id" class="text-break">
					@logMessage.Message
				</a>
			</div>
		</div>
	}
}

@code {
	[CascadingParameter(Name = "ErrorService")]
	protected IErrorService? ErrorService { get; set; }

	private List<LogMessageListItemModel>? logMessages;

	private ISubscriber? Subscriber;

	private string LimitDisplayLength(string? value, int maxLength)
	{
		if (maxLength < 3) throw new InvalidOperationException("MaxLength must be greater than 3");
		if (string.IsNullOrWhiteSpace(value)) return "";
		if (value.Length <= maxLength) return value;
		return value.Substring(0, maxLength - 3) + "...";
	}

	protected override async Task OnInitializedAsync()
	{
		var state = await AuthenticationService.GetAuthenticationStateAsync();

		if (state.User.Identity is null)
		{
			var url = NavigationManager.BuildReturnUrl("/login");
			NavigationManager.NavigateTo(url);
			return;
		}

		try
		{
			logMessages = new List<LogMessageListItemModel>(await LogMessageService.GetItemsAsync(true));

			Subscriber = await SubscriberProvider.GetSubscriber();

			Subscriber.Register<LogMessageCreated>(Handle);

			await Subscriber.StartAsync();
		}
		catch (System.Security.Authentication.AuthenticationException)
		{
			var url = NavigationManager.BuildReturnUrl("/login");
			NavigationManager.NavigateTo(url);
		}
		catch (Exception ex)
		{
			Log.LogError(ex, "Error loading logmessages.");
			ErrorService?.ShowError("Error", "Could not load. Server error.");
		}
	}

	private async Task Handle(LogMessageCreated message)
	{
		if (logMessages is null)
		{
			return;
		}

		var item = new LogMessageListItemModel()
		{
			Id = message.Id,
			DateTime = message.DateTime,
			LogLevel = message.LogLevel,
			Message = message.Message
		};

		logMessages.Insert(0, item);

		await InvokeAsync(StateHasChanged);
	}

	public void Dispose()
	{
		Subscriber?.Unregister(this);
	}
}
