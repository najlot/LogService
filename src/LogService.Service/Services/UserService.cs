using Cosei.Service.Base;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using LogService.Contracts;
using LogService.Service.Model;
using LogService.Service.Repository;
using LogService.Contracts.Commands;
using LogService.Contracts.Events;
using LogService.Contracts.ListItems;
using System.Text;
using System.Security.Cryptography;

namespace LogService.Service.Services;

public class UserService : IUserService
{
	private readonly IUserRepository _userRepository;
	private readonly IPublisher _publisher;

	public UserService(
		IUserRepository userRepository,
		IPublisher publisher)
	{
		_userRepository = userRepository;
		_publisher = publisher;
	}

	public async Task CreateUser(CreateUser command, Guid userId)
	{
		var username = command.Username.Normalize().ToLower();

		var user = await _userRepository.Get(username).ConfigureAwait(false);
		if (user != null)
		{
			throw new InvalidOperationException("User already exists!");
		}

		if (command.Password.Trim().Length < 6)
		{
			throw new InvalidOperationException("Password too short!");
		}

		var passwordBytes = Encoding.UTF8.GetBytes(command.Password);

		var item = new UserModel()
		{
			Id = command.Id,
			Username = username,
			EMail = command.EMail,
			PasswordHash = SHA256.HashData(passwordBytes),
			IsActive = true
		};

		await _userRepository.Insert(item).ConfigureAwait(false);

		await _publisher.PublishAsync(new UserCreated(
			command.Id,
			username,
			command.EMail)).ConfigureAwait(false);
	}

	public async Task UpdateUser(UpdateUser command, Guid userId)
	{
		var username = command.Username.Normalize().ToLower();

		var item = await _userRepository.Get(command.Id).ConfigureAwait(false);

		if (item == null)
		{
			throw new InvalidOperationException("User not found!");
		}

		item.Username = item.Username.Normalize().ToLower();

		if (item.Id != userId)
		{
			throw new InvalidOperationException("You must not modify other users!");
		}

		if (item.Username != username)
		{
			throw new InvalidOperationException("Username can not be modified!");
		}

		item.Username = username;
		item.EMail = command.EMail;

		if (!string.IsNullOrWhiteSpace(command.Password))
		{
			if (command.Password.Trim().Length < 6)
			{
				throw new InvalidOperationException("Password too short!");
			}

			var passwordBytes = Encoding.UTF8.GetBytes(command.Password);
			item.PasswordHash = SHA256.HashData(passwordBytes);
		}

		await _userRepository.Update(item).ConfigureAwait(false);

		await _publisher.PublishAsync(new UserUpdated(
			command.Id,
			username,
			command.EMail)).ConfigureAwait(false);
	}

	public async Task DeleteUser(Guid id, Guid userId)
	{
		var item = await _userRepository.Get(id).ConfigureAwait(false);

		if (item == null)
		{
			throw new InvalidOperationException("User not found!");
		}

		if (item.Id != userId)
		{
			throw new InvalidOperationException("You must not delete other user!");
		}

		item.IsActive = false;

		await _userRepository.Update(item).ConfigureAwait(false);

		await _publisher.PublishAsync(new UserDeleted(id)).ConfigureAwait(false);
	}

	public async Task<User?> GetItemAsync(Guid id)
	{
		var item = await _userRepository.Get(id).ConfigureAwait(false);

		if (item == null)
		{
			return null;
		}

		return new User
		{
			Id = item.Id,
			Username = item.Username,
			EMail = item.EMail,
		};
	}

	public async IAsyncEnumerable<UserListItem> GetItemsForUserAsync(Guid userId)
	{
		await foreach (var item in _userRepository.GetAll().ConfigureAwait(false))
		{
			if (!item.IsActive)
			{
				continue;
			}

			yield return new UserListItem
			{
				Id = item.Id,
				Username = item.Username,
				EMail = item.EMail,
			};
		}
	}

	public async Task<UserModel?> GetUserModelFromName(string username)
	{
		username = username.Normalize().ToLower();

		var user = await _userRepository.Get(username).ConfigureAwait(false);
		return user;
	}
}